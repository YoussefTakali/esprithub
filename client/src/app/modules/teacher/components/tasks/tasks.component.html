<!-- Template will be based on your provided classes.component.html, adapted for teacher's view -->
<span></span>
<div class="task-management-container">
  <!-- Sidebar and main content for teacher's tasks page, adapted from classes.component.html -->
  <div class="task-management-container">
    <div class="sidebar">
      <h2 class="sidebar-title">My Classes & Projects</h2>
      <div class="tree-view">
        <h2 class="tree-title">Classes</h2>
        <div *ngFor="let classe of teacherClasses" class="tree-item">
          <div class="tree-node class-node" [class.expanded]="classe.expanded" [class.selected]="selectedClass?.id === classe.id">
            <button class="tree-icon arrow-icon" (click)="toggleClass(classe)">
              <i class="fas" [class.fa-chevron-right]="!classe.expanded" [class.fa-chevron-down]="classe.expanded"></i>
            </button>
            <span class="tree-icon class-icon">
              <i class="fas fa-graduation-cap"></i>
            </span>
            <span class="tree-label class-label">{{ classe.className }}</span>
            <span class="item-count">({{ classe.projects?.length || 0 }} projects)</span>
          </div>
         
          <!-- Projects under Class -->
          <div class="tree-children" *ngIf="classe.expanded">
            <div *ngFor="let project of classe.projects" class="tree-item project-level">
              <h2 class="tree-title">Projects</h2>
              <div class="tree-node project-node" [class.expanded]="project.expanded" [class.selected]="selectedProject?.id === project.id">
                <button class="tree-icon arrow-icon" (click)="toggleProject(project)">
                  <i class="fas" [class.fa-chevron-right]="!project.expanded" [class.fa-chevron-down]="project.expanded"></i>
                </button>
                <span class="tree-icon project-icon">
                  <i class="fas fa-folder-open"></i>
                </span>
                <span class="tree-label project-label">{{ project.name }}</span>
                <span class="item-count">({{ project.groups?.length || 0 }} groups)</span>
              </div>
             
              <!-- Groups under Project -->
              <div class="tree-children group-level" *ngIf="project.expanded">
                <h2 class="tree-title">Groups</h2>
                <div *ngFor="let group of project.groups" class="tree-item">
                  <div class="tree-node group-node" [class.expanded]="group.expanded">
                    <button class="tree-icon arrow-icon" (click)="toggleGroup(group)">
                      <i class="fas" [class.fa-chevron-right]="!group.expanded" [class.fa-chevron-down]="group.expanded"></i>
                    </button>
                    <span class="tree-icon group-icon">
                      <i class="fas fa-users"></i>
                    </span>
                    <span class="tree-label group-label">{{ group.name }}</span>
                    <span class="item-count">({{ group.memberIds?.length || 0 }} members)</span>
                  </div>
                 
                  <!-- Members under Group -->
                  <div class="tree-children member-level" *ngIf="group.expanded">
                    <h2 class="tree-title">Members</h2>
                    <div *ngFor="let memberId of group.memberIds" class="tree-item">
                      <div class="tree-node member-node">
                        <span class="tree-icon member-icon">
                          <i class="fas fa-user"></i>
                        </span>
                        <span class="tree-label member-label">{{ getStudentName(memberId) }}</span>
                        <span class="member-role">Student</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Main Content - Task list -->
    <div class="main-content">
      <div class="content-header">
        <div class="header-left">
          <h1 class="content-title">
            <i class="fas fa-tasks"></i>
            Tasks for {{ selectedProject?.name || 'All Projects' }}
          </h1>
         
          <!-- Breadcrumb Navigation -->
          <div class="breadcrumb" *ngIf="selectedClass || selectedProject">
            <span *ngIf="selectedClass" class="breadcrumb-item class-breadcrumb">
              <i class="fas fa-graduation-cap"></i>
              {{ selectedClass.className }}
            </span>
            <span *ngIf="selectedProject" class="breadcrumb-separator">></span>
            <span *ngIf="selectedProject" class="breadcrumb-item project-breadcrumb">
              <i class="fas fa-folder-open"></i>
              {{ selectedProject.name }}
            </span>
          </div>
         
          <!-- Context Description -->
          <p class="content-description">
            <span *ngIf="!selectedClass && !selectedProject">Select a class and project to manage tasks</span>
            <span *ngIf="selectedClass && !selectedProject">Select a project from {{ selectedClass.className }} to view tasks</span>
            <span *ngIf="selectedProject">Managing tasks for {{ selectedProject.name }} project</span>
          </p>
        </div>
       
        <div class="header-actions">
          <div class="search-container">
            <i class="fas fa-search search-icon"></i>
            <input type="text"
                   placeholder="Search tasks..."
                   class="search-input"
                   [(ngModel)]="searchTerm">
          </div>
          <button class="add-task-btn" (click)="addTask()">
            <i class="fas fa-plus"></i>
            Add Task
          </button>
        </div>
      </div>
 
      <!-- Context Info Cards -->
      <div class="context-panel" *ngIf="selectedClass || selectedProject">
        <div class="context-card class-context" *ngIf="selectedClass">
          <div class="context-header">
            <i class="fas fa-graduation-cap"></i>
            <h3>{{ selectedClass.className }}</h3>
          </div>
          <div class="context-stats">
            <span class="stat-item">
              <i class="fas fa-folder"></i>
              {{ selectedClass.projects?.length || 0 }} Projects
            </span>
          </div>
        </div>
 
        <div class="context-card project-context" *ngIf="selectedProject">
          <div class="context-header">
            <i class="fas fa-folder-open"></i>
            <h3>{{ selectedProject.name }}</h3>
          </div>
          <div class="context-stats">
            <span class="stat-item">
              <i class="fas fa-users"></i>
              {{ selectedProject.groups?.length || 0 }} Groups
            </span>
            <span class="stat-item">
              <i class="fas fa-tasks"></i>
              {{ filteredTasks?.length || 0 }} Tasks
            </span>
          </div>
        </div>
      </div>
 
      <!-- Task Statistics -->
      <div class="task-stats" *ngIf="filteredTasks && filteredTasks.length > 0">
        <div class="stat-card draft-stat">
          <div class="stat-number">{{ getTaskCountByStatus('DRAFT') }}</div>
          <div class="stat-label">Draft</div>
          <div class="stat-icon">
            <i class="fas fa-edit"></i>
          </div>
        </div>
        <div class="stat-card published-stat">
          <div class="stat-number">{{ getTaskCountByStatus('PUBLISHED') }}</div>
          <div class="stat-label">Published</div>
          <div class="stat-icon">
            <i class="fas fa-eye"></i>
          </div>
        </div>
        <div class="stat-card progress-stat">
          <div class="stat-number">{{ getTaskCountByStatus('IN_PROGRESS') }}</div>
          <div class="stat-label">In Progress</div>
          <div class="stat-icon">
            <i class="fas fa-clock"></i>
          </div>
        </div>
        <div class="stat-card completed-stat">
          <div class="stat-number">{{ getTaskCountByStatus('COMPLETED') }}</div>
          <div class="stat-label">Completed</div>
          <div class="stat-icon">
            <i class="fas fa-check-circle"></i>
          </div>
        </div>
      </div>
 
      <!-- Empty State -->
      <div class="empty-state" *ngIf="!filteredTasks || filteredTasks.length === 0">
        <div class="empty-icon">
          <i class="fas fa-tasks"></i>
        </div>
        <h3>No tasks found</h3>
        <p *ngIf="!selectedProject">Select a project to view and manage tasks</p>
        <p *ngIf="selectedProject && searchTerm">No tasks match your search criteria</p>
        <p *ngIf="selectedProject && !searchTerm">No tasks created yet for this project</p>
        <button class="create-first-task-btn" *ngIf="selectedProject && !searchTerm" (click)="addTask()">
          <i class="fas fa-plus"></i>
          Create Your First Task
        </button>
      </div>
 
      <div class="task-grid">
        <div *ngFor="let task of filteredTasks" class="task-card">
          <div class="task-header">
            <div class="task-title-section">
              <div class="task-title">{{ task.title }}</div>
              <div class="task-badges">
                <span class="graded-badge" *ngIf="task.graded">
                  <i class="fas fa-award"></i>
                  Graded
                </span>
                <span class="visibility-badge" [class.visible]="task.visible" [class.hidden]="!task.visible">
                  <i class="fas" [class.fa-eye]="task.visible" [class.fa-eye-slash]="!task.visible"></i>
                  {{ task.visible ? 'Visible' : 'Hidden' }}
                </span>
              </div>
            </div>
            <span class="task-status-dropdown"
              [ngClass]="{
                'status-pending': task.status === 'DRAFT',
                'status-in-progress': task.status === 'IN_PROGRESS',
                'status-completed': task.status === 'COMPLETED',
                'status-published': task.status === 'PUBLISHED'
              }"
              [class.show-dropdown]="task.showStatusDropdown"
              (click)="toggleStatusDropdown(task)">
              {{ task.status }}
              <i class="fas fa-chevron-down dropdown-arrow"></i>
              <div class="status-dropdown-menu" *ngIf="task.showStatusDropdown">
                <div class="status-option" (click)="changeTaskStatus(task, 'DRAFT')">Draft</div>
                <div class="status-option" (click)="changeTaskStatus(task, 'PUBLISHED')">Published</div>
                <div class="status-option" (click)="changeTaskStatus(task, 'IN_PROGRESS')">In Progress</div>
                <div class="status-option" (click)="changeTaskStatus(task, 'COMPLETED')">Completed</div>
                <div class="status-option" (click)="changeTaskStatus(task, 'CLOSED')">Closed</div>
              </div>
            </span>
          </div>
          <div class="task-description">{{ task.description }}</div>
          <div class="task-assigned-to task-scope">
            <ng-container *ngIf="task.projectNames?.length">
              <span class="scope-item project-scope">
                <i class="fas fa-folder-open"></i>
                Projects: {{ task.projectNames.join(', ') }}
              </span>
            </ng-container>
            <ng-container *ngIf="task.classNames?.length">
              <span class="scope-item class-scope">
                <i class="fas fa-graduation-cap"></i>
                Classes: {{ task.classNames.join(', ') }}
              </span>
            </ng-container>
            <ng-container *ngIf="task.groupNames?.length">
              <span class="scope-item group-scope">
                <i class="fas fa-users"></i>
                Groups: {{ task.groupNames.join(', ') }}
              </span>
            </ng-container>
            <ng-container *ngIf="task.studentNames?.length">
              <span class="scope-item student-scope">
                <i class="fas fa-user"></i>
                Students: {{ task.studentNames.join(', ') }}
              </span>
            </ng-container>
          </div>
          <div class="task-meta">
            <div class="task-due-date"><i class="fas fa-calendar-alt meta-icon"></i> Due: {{ task.dueDate | date:'medium' }}</div>
            <div class="task-assignee" *ngIf="task.assignedToStudent"><i class="fas fa-user meta-icon"></i> {{ getStudentName(task.assignedToStudent) }}</div>
            <div class="task-assignee" *ngIf="task.assignedToGroup"><i class="fas fa-users meta-icon"></i> Group</div>
            <div class="task-assignee" *ngIf="task.assignedToClasse"><i class="fas fa-graduation-cap meta-icon"></i> Class</div>
            <div class="task-created">
              <i class="fas fa-clock meta-icon"></i>
              Created: {{ task.createdAt | date:'short' }}
            </div>
          </div>
          <div class="task-actions">
            <button class="action-btn visibility-btn"
                    (click)="toggleTaskVisibility(task)"
                    [title]="task.visible ? 'Hide Task' : 'Show Task'">
              <i class="fas" [class.fa-eye]="task.visible" [class.fa-eye-slash]="!task.visible"></i>
              {{ task.visible ? 'Hide' : 'Show' }}
            </button>
            <button class="action-btn edit-btn" (click)="editTask(task)"><i class="fas fa-edit"></i> Edit</button>
            <button class="action-btn delete-btn" (click)="confirmDeleteTask(task)"><i class="fas fa-trash"></i> Delete</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
 
<!-- Create Group Modal -->
<div class="modal-backdrop" *ngIf="showCreateGroupModal" (click)="closeCreateGroupModal()" (keydown.escape)="closeCreateGroupModal()"></div>
<div class="modal" *ngIf="showCreateGroupModal">
  <div class="modal-content" (click)="$event.stopPropagation()" (keydown.escape)="closeCreateGroupModal()">
    <h3 style="color:#C9091D">Create New Group</h3>
    <form (ngSubmit)="createGroupSubmit()">
      <label for="groupName">Group Name</label>
      <input id="groupName" class="modal-input" [(ngModel)]="groupNameInput" name="groupNameInput" required placeholder="Group Name" />
      <label for="groupMembers">Members</label>
      <input id="groupMembers" class="modal-input" [(ngModel)]="groupMembersInput" name="groupMembersInput" placeholder="Type name or email to add..." (input)="onGroupMemberInput()" autocomplete="off" />
      <ul *ngIf="groupMemberSuggestions.length > 0 || groupMembersInput.trim() !== ''" class="autocomplete-list">
        <li *ngFor="let user of groupMemberSuggestions">
          <button type="button" (click)="selectGroupMember(user)">
            <div><b>{{ user.fullName || user.name || user.email }}</b></div>
            <div style="font-size:12px;color:#888">{{ user.email }}</div>
          </button>
        </li>
        <li *ngIf="groupMemberSuggestions.length === 0">
          <div class="no-match">No student found</div>
        </li>
      </ul>
      <div class="selected-collaborators">
        <span *ngFor="let m of selectedGroupMembers">
          {{ m.fullName || m.name || m.email }}
          <button type="button" (click)="removeGroupMember(m.id)">&times;</button>
        </span>
      </div>
      <div *ngIf="repoCreationInProgress" class="repo-creation-modal">
        <mat-progress-bar mode="indeterminate"></mat-progress-bar>
        <div class="step-msg">{{ repoCreationStepMsg }}</div>
      </div>
      <div *ngIf="createdRepoUrl && !repoCreationInProgress" class="repo-url-success">
        <mat-icon color="primary">check_circle</mat-icon>
        <div>
          Repository for group <b>{{ groupNameInput }}</b> created:<br>
          <a href="{{ createdRepoUrl }}" target="_blank">{{ createdRepoUrl }}</a>
        </div>
      </div>
      <div *ngIf="!repoCreationInProgress && !createdRepoUrl && repoCreationStep === 'none' && repoCreationStepMsg === ''">
        <div class="repo-url-error" *ngIf="repoCreationStep === 'none' && !createdRepoUrl">
          <mat-icon color="warn">error</mat-icon>
          <span>Repository creation failed. Please try again.</span>
        </div>
      </div>
      <div class="modal-actions">
        <button class="create-btn-red" type="submit" style="background-color:#C9091D">Create</button>
        <button class="cancel-btn" type="button" (click)="closeCreateGroupModal()">Cancel</button>
      </div>
    </form>
  </div>
</div>
<!-- Add Member Modal -->
<div class="modal-backdrop" *ngIf="showAddMemberModal" (click)="closeAddMemberModal()" (keydown.escape)="closeAddMemberModal()"></div>
<div class="modal" *ngIf="showAddMemberModal">
  <div class="modal-content" (click)="$event.stopPropagation()" (keydown.escape)="closeAddMemberModal()">
    <h3 style="color:#C9091D">Add Member to Group</h3>
    <label for="addMember">Member</label>
    <input id="addMember" class="modal-input" [(ngModel)]="addMemberInput" name="addMemberInput" placeholder="Type name or email..." (input)="onAddMemberInput()" autocomplete="off" />
    <ul *ngIf="addMemberSuggestions.length > 0" class="autocomplete-list">
      <li *ngFor="let user of addMemberSuggestions">
        <button type="button" (click)="selectAddMember(user)">
          <div><b>{{ user.fullName || user.name || user.email }}</b></div>
          <div style="font-size:12px;color:#888">{{ user.email }}</div>
        </button>
      </li>
    </ul>
    <div class="modal-actions">
      <button class="cancel-btn" type="button" (click)="closeAddMemberModal()">Cancel</button>
    </div>
  </div>
</div>
<!-- Remove Group Modal -->
<div class="modal-backdrop" *ngIf="showRemoveGroupModal" (click)="closeRemoveGroupModal()" (keydown.escape)="closeRemoveGroupModal()"></div>
<div class="modal" *ngIf="showRemoveGroupModal">
  <div class="modal-content" (click)="$event.stopPropagation()" (keydown.escape)="closeRemoveGroupModal()">
    <h3 style="color:#C9091D">Confirm Delete</h3>
    <div style="margin-bottom: 16px;">Are you sure you want to delete the group <b>{{ groupToDelete?.name }}</b>?</div>
   
    <!-- Repository deletion option -->
    <div class="repository-deletion-option">
      <label>
        <input
          type="checkbox"
          [(ngModel)]="deleteRepositoryWithGroup">
        <span>
          Also delete the associated GitHub repository
        </span>
      </label>
      <div class="repository-deletion-info">
        <i class="fas fa-info-circle"></i>
        <span>If unchecked, the repository will remain available but will not be linked to any group.</span>
      </div>
    </div>
   
    <div class="modal-actions">
      <button class="create-btn-red" (click)="removeGroupSubmit()">Delete</button>
      <button class="cancel-btn" (click)="closeRemoveGroupModal()">Cancel</button>
    </div>
  </div>
</div>
<!-- Remove Member Modal -->
<div class="modal-backdrop" *ngIf="showRemoveMemberModal" (click)="closeRemoveMemberModal()" (keydown.escape)="closeRemoveMemberModal()"></div>
<div class="modal" *ngIf="showRemoveMemberModal">
  <div class="modal-content" (click)="$event.stopPropagation()" (keydown.escape)="closeRemoveMemberModal()">
    <h3 style="color:#C9091D">Remove Member</h3>
    <div style="margin-bottom: 16px;">Are you sure you want to remove <b>{{ getStudentName(memberToRemove) }}</b> from group <b>{{ groupToRemoveMember?.name }}</b>?</div>
    <div class="modal-actions">
      <button class="create-btn-red" (click)="removeMemberSubmit()">Remove</button>
      <button class="cancel-btn" (click)="closeRemoveMemberModal()">Cancel</button>
    </div>
  </div>
</div>
<!-- Add Task Modal -->
<div class="modal-backdrop" *ngIf="showAddTaskModal" (click)="closeAddTaskModal()" (keydown.escape)="closeAddTaskModal()"></div>
<div class="modal" *ngIf="showAddTaskModal">
  <div class="modal-content" (click)="$event.stopPropagation()" (keydown.escape)="closeAddTaskModal()">
    <h3 style="color:#C9091D">Create New Task</h3>
    <form (ngSubmit)="addTaskSubmit()">
      <label for="taskTitle">Title</label>
      <input id="taskTitle" class="modal-input" [(ngModel)]="addTaskForm.title" name="addTaskTitle" required placeholder="Task Title" />
      <label for="taskDescription">Description</label>
      <textarea id="taskDescription" class="modal-input" [(ngModel)]="addTaskForm.description" name="addTaskDescription" placeholder="Task Description"></textarea>
      <label for="taskDueDate">Deadline</label>
      <input id="taskDueDate" class="modal-input" type="datetime-local" [(ngModel)]="addTaskForm.dueDate" name="addTaskDueDate" required />
      <label for="taskScope">Scope</label>
      <select id="taskScope" class="modal-input" [(ngModel)]="addTaskForm.scopeType" name="addTaskScope" required>
        <option value="">Select scope...</option>
        <option value="PROJECT">Project</option>
        <option value="CLASSE">Class</option>
        <option value="GROUP">Group</option>
        <option value="INDIVIDUAL">Individual</option>
      </select>
      <ng-container [ngSwitch]="addTaskForm.scopeType">
        <div *ngSwitchCase="'PROJECT'">
          <span class="multi-select-label">Projects</span>
          <div class="multi-select-list">
            <label *ngFor="let p of availableScopeProjects">
              <input type="checkbox"
                     [value]="p.id"
                     [checked]="addTaskForm.projectIds.includes(p.id)"
                     (change)="onProjectCheckboxChange($event, p.id)"
                     name="addTaskProjectIds" />
              {{ p.name }}
            </label>
          </div>
        </div>
        <div *ngSwitchCase="'CLASSE'">
          <span class="multi-select-label">Classes</span>
          <div class="multi-select-list">
            <label *ngFor="let c of availableScopeClasses">
              <input type="checkbox"
                     [value]="c.classId"
                     [checked]="addTaskForm.classIds.includes(c.classId)"
                     (change)="onClassCheckboxChange($event, c.classId)"
                     name="addTaskClassIds" />
              {{ c.className }}
            </label>
          </div>
        </div>
        <div *ngSwitchCase="'GROUP'">
          <span class="multi-select-label">Groups</span>
          <div class="multi-select-list">
            <label *ngFor="let g of availableScopeGroups">
              <input type="checkbox"
                     [value]="g.id"
                     [checked]="addTaskForm.groupIds.includes(g.id)"
                     (change)="onGroupCheckboxChange($event, g.id)"
                     name="addTaskGroupIds" />
              {{ g.name }} ({{ getGroupContext(g) }})
            </label>
          </div>
        </div>
        <div *ngSwitchCase="'INDIVIDUAL'">
          <span class="multi-select-label">Students</span>
          <div class="multi-select-list">
            <label *ngFor="let s of availableScopeStudents">
              <input type="checkbox"
                     [value]="s.id"
                     [checked]="addTaskForm.studentIds.includes(s.id)"
                     (change)="onStudentCheckboxChange($event, s.id)"
                     name="addTaskStudentIds" />
              {{ s.fullName || s.name || s.email }} ({{ getStudentContext(s) }})
            </label>
          </div>
        </div>
      </ng-container>
      <label for="taskStatus">Status</label>
      <select id="taskStatus" class="modal-input" [(ngModel)]="addTaskForm.status" name="addTaskStatus" required>
        <option value="DRAFT">Draft</option>
        <option value="PUBLISHED">Published</option>
        <option value="IN_PROGRESS">In Progress</option>
        <option value="COMPLETED">Completed</option>
        <option value="CLOSED">Closed</option>
      </select>
      <div style="display:flex; gap:1rem; align-items:center;">
        <label><input type="checkbox" [(ngModel)]="addTaskForm.isGraded" name="addTaskIsGraded" /> Graded</label>
        <label><input type="checkbox" [(ngModel)]="addTaskForm.visible" name="addTaskVisible" /> Visible</label>
      </div>
      <div class="modal-actions">
        <button class="create-btn-red" type="submit" style="background-color:#C9091D">Create</button>
        <button class="cancel-btn" type="button" (click)="closeAddTaskModal()">Cancel</button>
      </div>
    </form>
  </div>
</div>
<!-- Edit Task Modal -->
<div class="modal-backdrop" *ngIf="showEditTaskModal" (click)="closeEditTaskModal()" (keydown.escape)="closeEditTaskModal()"></div>
<div class="modal" *ngIf="showEditTaskModal">
  <div class="modal-content" (click)="$event.stopPropagation()" (keydown.escape)="closeEditTaskModal()">
    <h3 style="color:#e74c3c">Edit Task</h3>
    <form (ngSubmit)="editTaskSubmit()">
      <label for="editTaskTitle">Title</label>
      <input id="editTaskTitle" class="modal-input" [(ngModel)]="editTaskForm.title" name="editTaskTitle" required placeholder="Task Title" />
      <label for="editTaskDescription">Description</label>
      <textarea id="editTaskDescription" class="modal-input" [(ngModel)]="editTaskForm.description" name="editTaskDescription" placeholder="Task Description"></textarea>
      <label for="editTaskDueDate">Deadline</label>
      <input id="editTaskDueDate" class="modal-input" type="datetime-local" [(ngModel)]="editTaskForm.dueDate" name="editTaskDueDate" required />
      <label for="editTaskStatus">Status</label>
      <select id="editTaskStatus" class="modal-input" [(ngModel)]="editTaskForm.status" name="editTaskStatus" required>
        <option value="DRAFT">Draft</option>
        <option value="PUBLISHED">Published</option>
        <option value="IN_PROGRESS">In Progress</option>
        <option value="COMPLETED">Completed</option>
        <option value="CLOSED">Closed</option>
      </select>
      <div style="display:flex; gap:1rem; align-items:center;">
        <label><input type="checkbox" [(ngModel)]="editTaskForm.isGraded" name="editTaskIsGraded" /> Graded</label>
        <label><input type="checkbox" [(ngModel)]="editTaskForm.visible" name="editTaskVisible" /> Visible</label>
      </div>
      <div class="modal-actions">
        <button class="create-btn-red" type="submit">Save</button>
        <button class="cancel-btn" type="button" (click)="closeEditTaskModal()">Cancel</button>
      </div>
    </form>
  </div>
</div>
 
 
 