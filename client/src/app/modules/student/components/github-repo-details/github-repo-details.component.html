<div class="repository-dashboard" *ngIf="repository && !loading && !error">
  <!-- Header -->
  <div class="dashboard-header">
    <div class="header-left">
      <button class="back-btn" (click)="goBack()">
        <i class="fas fa-arrow-left"></i>
        Back to Repositories
      </button>
      <div class="repo-info">
        <i class="fas fa-folder folder-icon"></i>
        <span class="repo-label">Public repository</span>
        <h1 class="repo-path">{{ repository.owner?.login }}/{{ repository.name }}</h1>
      </div>
    </div>
    <div class="header-right">
      <div class="header-actions">
        <button class="btn-add-file">
          <i class="fas fa-plus"></i>
          Add file
        </button>
        <button class="btn-code" (click)="toggleCloneModal()">
          <i class="fas fa-code"></i>
          Code
        </button>
      </div>
    </div>
  </div>

  <!-- View Commit History Button -->
  <div class="commit-history-section">
    <button class="view-commit-history-btn" (click)="showCommitDetailsView(latestCommit)">
      <i class="fas fa-history"></i>
      View Commit History
    </button>
  </div>

  <!-- Tab Navigation -->
  <div class="tab-navigation">
    <div class="nav-tabs">
      <button class="nav-tab" 
              [class.active]="activeTab === 'code'"
              (click)="setActiveTab('code')">
        <i class="fas fa-code"></i>
        Code
      </button>
      <button class="nav-tab" 
              [class.active]="activeTab === 'statistics'"
              (click)="setActiveTab('statistics')">
        <i class="fas fa-chart-line"></i>
        Statistics
      </button>
    </div>
    <div class="branch-selector">
      <span>Branch:</span>
      <select class="branch-dropdown" [(ngModel)]="currentBranch" (change)="switchBranch(currentBranch)">
        <option [value]="repository.defaultBranch || 'main'">{{ repository.defaultBranch || 'main' }}</option>
        <option *ngFor="let branch of branches" [value]="branch.name" 
                [selected]="branch.name === currentBranch">
          {{ branch.name }}
        </option>
      </select>
    </div>
  </div>

  <!-- Code View -->
  <div class="code-content" *ngIf="activeTab === 'code'">
    <div class="main-content">
      <!-- Latest Commit Banner -->
      <div class="latest-commit-banner" 
           (click)="showCommitDetailsView(latestCommit)" 
           (keydown.enter)="showCommitDetailsView(latestCommit)"
           (keydown.space)="showCommitDetailsView(latestCommit)"
           tabindex="0"
           role="button"
           style="cursor: pointer;" 
           title="View commit details"
           [attr.aria-label]="'View commit details: ' + (latestCommit?.message || 'No commits')"
           *ngIf="latestCommit">
        <div class="commit-icon">
          <i class="fas fa-circle"></i>
        </div>
        <div class="commit-info">
          <span class="commit-label">LATEST COMMIT:</span>
          <span class="commit-message">{{ latestCommit.message }}</span>
          <span class="commit-author" *ngIf="latestCommit.author">by {{ latestCommit.author }}</span>
        </div>
        <div class="commit-details">
          <img *ngIf="latestCommit.avatarUrl" 
               [src]="latestCommit.avatarUrl" 
               [alt]="latestCommit.author"
               class="commit-avatar">
          <div class="commit-meta">
            <span class="commit-sha">{{ latestCommit.sha }}</span>
            <span class="commit-date">{{ latestCommit.date }}</span>
          </div>
        </div>
      </div>

      <!-- No commits message -->
      <div class="no-commits-banner" *ngIf="!latestCommit && !loading">
        <div class="commit-icon">
          <i class="fas fa-info-circle"></i>
        </div>
        <div class="commit-info">
          <span class="commit-label">NO COMMITS YET</span>
          <span class="commit-message">This repository doesn't have any commits yet.</span>
        </div>
      </div>

      <!-- File Browser -->
      <div class="file-browser">
        <div class="file-browser-header">
          <div class="breadcrumb-nav" *ngIf="currentPath.length > 0">
            <button class="breadcrumb-btn" (click)="navigateToRoot()">
              <i class="fas fa-home"></i>
              Repository
            </button>
            <span class="breadcrumb-separator">/</span>
            <span class="breadcrumb-item" *ngFor="let path of currentPath; let i = index">
              <button class="breadcrumb-btn" (click)="navigateToPath(i)">{{ path }}</button>
              <span class="breadcrumb-separator" *ngIf="i < currentPath.length - 1">/</span>
            </span>
          </div>
        </div>
        
        <div class="file-list-header">
          <div class="header-col name">NAME</div>
          <div class="header-col message">COMMIT MESSAGE</div>
          <div class="header-col committer">COMMITTER</div>
          <div class="header-col updated">UPDATED</div>
        </div>
        <div class="file-list">
          <div class="file-item" *ngFor="let file of repositoryFiles" 
               (click)="onFileClick(file)"
               (keyup.enter)="onFileClick(file)"
               tabindex="0"
               role="button"
               [attr.aria-label]="'Open ' + file.name">
            <div class="file-icon">
              <i [class]="getFileIcon(file.type)" 
                 [style.color]="getFileIconColor(file.name, file.type)"></i>
            </div>
            <div class="file-name">
              <span>{{ file.name }}</span>
            </div>
            <div class="file-message">
              <span>{{ file.message }}</span>
            </div>
            <div class="file-committer">
              <span>{{ file.committer }}</span>
            </div>
            <div class="file-date">
              <span>{{ file.lastModified }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- File Actions for Selected File -->
      <div class="file-actions-bar" *ngIf="!showFileContent && !showCommitDetails">
        <div class="file-action-buttons">
          <button class="action-btn btn-view" *ngIf="selectedFile">
            <i class="fas fa-eye"></i>
            View
          </button>
          <button class="action-btn btn-edit" *ngIf="selectedFile">
            <i class="fas fa-edit"></i>
            Edit
          </button>
          <button class="action-btn btn-download" *ngIf="selectedFile">
            <i class="fas fa-download"></i>
            Download
          </button>
          <button class="action-btn btn-replace" *ngIf="selectedFile">
            <i class="fas fa-upload"></i>
            Replace
          </button>
          <button class="action-btn btn-delete" *ngIf="selectedFile">
            <i class="fas fa-trash"></i>
            Delete
          </button>
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar">
      <!-- Contributors -->
      <div class="sidebar-section">
        <h3>Contributors <span class="count">{{ contributors.length }}</span></h3>
        <div class="contributors-list">
          <div class="contributor" *ngFor="let contributor of contributors">
            <img [src]="contributor.avatar" [alt]="contributor.name" class="contributor-avatar">
            <div class="contributor-info">
              <span class="contributor-name">{{ contributor.name }}</span>
              <span class="contributor-commits">{{ contributor.commits }} commits</span>
            </div>
          </div>
        </div>
      </div>

      <!-- File Types -->
      <div class="sidebar-section">
        <h3><i class="fas fa-code"></i> File Types</h3>
        <div class="file-types-chart">
          <div class="file-type-item" *ngFor="let fileType of fileTypes">
            <div class="file-type-info">
              <div class="file-type-color" [style.background-color]="fileType.color"></div>
              <span class="file-type-name" [attr.data-type]="fileType.type">{{ fileType.type }}</span>
              <span class="file-type-percentage">{{ fileType.percentage }}%</span>
              <span class="file-type-size">({{ fileType.size }})</span>
            </div>
            <div class="file-type-bar">
              <div class="file-type-fill" 
                   [style.width.%]="fileType.percentage" 
                   [style.background-color]="fileType.color">
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- About -->
      <div class="sidebar-section">
        <h3>About</h3>
        <p class="description">{{ repository.description || 'No description available' }}</p>
        <div class="repo-stats-vertical">
          <div class="stat-row">
            <i class="far fa-star"></i>
            <span>{{ repository.stargazersCount || 0 }} stars</span>
          </div>
          <div class="stat-row">
            <i class="far fa-eye"></i>
            <span>{{ repository.watchersCount || 0 }} watching</span>
          </div>
          <div class="stat-row">
            <i class="fas fa-code-branch"></i>
            <span>{{ repository.forksCount || 0 }} forks</span>
          </div>
        </div>
        <!-- Repository Topics -->
        <div class="repo-topics" *ngIf="repository.topics && repository.topics.length > 0">
          <h4>Topics</h4>
          <div class="topic-tags">
            <span class="topic-tag" *ngFor="let topic of repository.topics">{{ topic }}</span>
          </div>
        </div>
        <!-- Repository Language -->
        <div class="repo-language" *ngIf="repository.language">
          <h4>Primary Language</h4>
          <span class="language-badge">{{ repository.language }}</span>
        </div>
        <!-- Repository License -->
        <div class="repo-license" *ngIf="repository.license">
          <h4>License</h4>
          <span class="license-info">{{ repository.license.name || repository.license }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Repository Dashboard (Statistics) -->
  <div class="repo-dashboard-content" *ngIf="activeTab === 'statistics'">
    <div class="dashboard-title">
      <h2>Repository Dashboard</h2>
      <span class="repo-path-subtitle">{{ repository.owner?.login }}/{{ repository.name }}</span>
      <button class="refresh-btn" (click)="refreshData()">
        <i class="fas fa-sync-alt"></i>
        Refresh
      </button>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon stars">
          <span class="stat-number">{{ repository.stargazersCount || 0 }}</span>
        </div>
        <div class="stat-label">STARS</div>
      </div>

      <div class="stat-card">
        <div class="stat-icon forks">
          <span class="stat-number">{{ repository.forksCount || 0 }}</span>
        </div>
        <div class="stat-label">FORKS</div>
      </div>

      <div class="stat-card">
        <div class="stat-icon watchers">
          <span class="stat-number">{{ repository.watchersCount || 0 }}</span>
        </div>
        <div class="stat-label">WATCHERS</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon contributors">
          <span class="stat-number">{{ dashboardStats.contributors }}</span>
        </div>
        <div class="stat-label">CONTRIBUTORS</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon total-commits">
          <span class="stat-number">{{ dashboardStats.totalCommits }}</span>
        </div>
        <div class="stat-label">TOTAL COMMITS (30 DAYS)</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon total-files">
          <span class="stat-number">{{ dashboardStats.totalFiles }}</span>
        </div>
        <div class="stat-label">TOTAL FILES</div>
      </div>
    </div>

    <!-- Activity Statistics -->
    <div class="activity-section">
      <div class="section-header">
        <h3>
          <i class="fas fa-chart-line"></i>
          Activity Statistics
        </h3>
        <div class="period-selector">
          <button 
            *ngFor="let period of activityPeriods" 
            class="period-btn"
            [class.active]="selectedActivityPeriod === period"
            (click)="onActivityPeriodChange(period)">
            {{ period }}
          </button>
        </div>
      </div>

      <div class="activity-stats">
        <div class="activity-stat">
          <span class="stat-label">Total Commits:</span>
          <span class="stat-value">{{ activityStats.totalCommits }}</span>
        </div>
        <div class="activity-stat">
          <span class="stat-label">Lines Added:</span>
          <span class="stat-value added">+{{ activityStats.linesAdded }}</span>
        </div>
        <div class="activity-stat">
          <span class="stat-label">Lines Deleted:</span>
          <span class="stat-value deleted">-{{ activityStats.linesDeleted }}</span>
        </div>
      </div>

      <!-- Daily Activity Chart -->
      <div class="daily-activity">
        <h4>Daily Activity</h4>
        <div class="activity-chart" *ngIf="commits.length > 0; else noActivityChart">
          <div class="chart-container">
            <div class="chart-bar">
              <div class="bar-line"></div>
              <div class="activity-point" 
                   *ngFor="let commit of commits.slice(0, 7); let i = index"
                   [style.left.%]="(i * 14) + 2">
                <div class="point-value">{{ commits.slice(i, i+1).length }}</div>
              </div>
            </div>
            <div class="chart-labels">
              <span class="chart-label" *ngFor="let commit of commits.slice(0, 7); let i = index">
                {{ formatDate(commit.date).split(' ')[0] }}
              </span>
            </div>
          </div>
        </div>
        <ng-template #noActivityChart>
          <div class="no-activity-chart">
            <p><i class="fas fa-info-circle"></i> No recent activity data available</p>
          </div>
        </ng-template>
      </div>
    </div>

    <!-- File Types Distribution -->
    <div class="file-types-section">
      <h3>
        <i class="fas fa-folder"></i>
        File Types Distribution
      </h3>
      <div class="file-types-chart">
        <div class="file-type-item" *ngFor="let fileType of fileTypes">
          <div class="file-type-color" [style.background-color]="fileType.color"></div>
          <span class="file-type-name" [attr.data-type]="fileType.type">{{ fileType.type }}</span>
          <span class="file-type-percentage">{{ fileType.percentage }}%</span>
          <div class="file-type-bar">
            <div class="file-type-fill" 
                 [style.width.%]="fileType.percentage" 
                 [style.background-color]="fileType.color">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Clone Modal -->
<div class="modal-overlay" *ngIf="showCloneModal" 
     (click)="closeCloneModal()" 
     (keydown.escape)="closeCloneModal()"
     role="dialog"
     aria-modal="true"
     aria-labelledby="clone-modal-title">
  <div class="clone-modal" (click)="$event.stopPropagation()" (keydown)="$event.stopPropagation()">
    <div class="modal-header">
      <h3 id="clone-modal-title"><i class="fas fa-download"></i> Clone or download this repository</h3>
      <button class="close-btn" (click)="closeCloneModal()" aria-label="Close modal">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="modal-content">
      <div class="clone-section">
        <h4><i class="fas fa-link"></i> Clone with HTTPS</h4>
        <p class="clone-description">Use Git or checkout with SVN using the web URL.</p>
        <div class="clone-url-container">
          <input type="text" 
                 [value]="repository.cloneUrl || 'https://github.com/' + (repository.owner?.login || repository.fullName?.split('/')[0]) + '/' + (repository.name || repository.fullName?.split('/')[1]) + '.git'" 
                 readonly 
                 class="clone-url-input">
          <button class="copy-btn" 
                  (click)="copyToClipboard(repository.cloneUrl || 'https://github.com/' + (repository.owner?.login || repository.fullName?.split('/')[0]) + '/' + (repository.name || repository.fullName?.split('/')[1]) + '.git')">>
            <i class="fas fa-copy"></i>
            Copy
          </button>
        </div>
      </div>
      
      <div class="download-section">
        <h4><i class="fas fa-download"></i> Download ZIP</h4>
        <button class="download-zip-btn" (click)="downloadZip()">
          <i class="fas fa-download"></i>
          Download ZIP ({{ currentBranch }} branch)
        </button>
        <p class="download-note">
          <i class="fas fa-info-circle"></i>
          Try direct GitHub download if the above doesn't work
        </p>
      </div>
    </div>
  </div>
</div>

<!-- File Content View Modal -->
<div class="modal-overlay" *ngIf="showFileContent" 
     (click)="closeFileView()" 
     (keydown.escape)="closeFileView()"
     role="dialog"
     aria-modal="true"
     aria-labelledby="file-modal-title">
  <div class="file-content-modal" (click)="$event.stopPropagation()" (keydown)="$event.stopPropagation()">
    <div class="file-header">
      <div class="file-path">
        <button class="back-btn" (click)="closeFileView()">
          <i class="fas fa-arrow-left"></i>
          Back to files
        </button>
        <span id="file-modal-title" class="file-name">{{ selectedFile?.name }}</span>
      </div>
      <div class="file-actions">
        <button class="btn-raw">Raw</button>
        <button class="btn-download">
          <i class="fas fa-download"></i>
          Download
        </button>
        <button class="btn-edit">
          <i class="fas fa-edit"></i>
          Edit
        </button>
        <button class="btn-replace">
          <i class="fas fa-upload"></i>
          Replace
        </button>
        <button class="btn-delete">
          <i class="fas fa-trash"></i>
          Delete
        </button>
      </div>
    </div>
    
    <div class="file-content">
      <div class="line-numbers">
        <div class="line-number" *ngFor="let line of fileContent.split('\n'); let i = index">{{ i + 1 }}</div>
      </div>
      <div class="file-code-content">
        <pre><code>{{ fileContent }}</code></pre>
      </div>
    </div>
  </div>
</div>

<!-- Commit Details View Modal -->
<div class="modal-overlay" *ngIf="showCommitDetails" 
     (click)="closeCommitDetails()" 
     (keydown.escape)="closeCommitDetails()"
     role="dialog"
     aria-modal="true"
     aria-labelledby="commit-modal-title">
  <div class="commit-details-modal" (click)="$event.stopPropagation()" (keydown)="$event.stopPropagation()">
    <div class="commit-header">
      <button class="back-btn" (click)="closeCommitDetails()">
        <i class="fas fa-arrow-left"></i>
        Back to Commit History
      </button>
      <div class="commit-info" *ngIf="selectedCommit">
        <h3 id="commit-modal-title">{{ getCommitDetails().message }}</h3>
        <div class="commit-meta">
          <span class="commit-author">{{ getCommitDetails().author }}</span>
          <span class="commit-date">{{ getCommitDetails().date }}</span>
          <span class="commit-sha">{{ getCommitDetails().sha }}</span>
        </div>
      </div>
    </div>
    
    <div class="commit-stats" *ngIf="getCommitDetails().stats.changedFiles > 0">
      <span class="stat">{{ getCommitDetails().stats.changedFiles }} changed files</span>
      <span class="stat additions">+{{ getCommitDetails().stats.additions }} additions</span>
      <span class="stat deletions">-{{ getCommitDetails().stats.deletions }} deletions</span>
    </div>
    
    <div class="commit-changes">
      <div class="change-item" *ngFor="let change of getCommitDetails().changes">
        <div class="change-header">
          <div class="file-status" [ngClass]="change.type">{{ change.type }}</div>
          <span class="change-file-name">{{ change.file }}</span>
          <span class="change-stats" *ngIf="!change.isBinary && change.additions > 0 || change.deletions > 0">
            +{{ change.additions }} -{{ change.deletions }}
          </span>
          <span class="binary-note" *ngIf="change.isBinary">Binary file</span>
        </div>
        
        <div class="diff-content" *ngIf="change.diff && !change.isBinary">
          <pre><code>{{ change.diff }}</code></pre>
        </div>
      </div>
    </div>
    
    <div class="commit-footer">
      <button class="view-on-github-btn" 
              *ngIf="selectedCommit?.url"
              (click)="window.open(selectedCommit.url, '_blank')">
        <i class="fas fa-external-link-alt"></i>
        View on GitHub
      </button>
    </div>
  </div>
</div>



<!-- Loading State -->
<div *ngIf="loading" class="loading-state">
  <div class="loading-spinner">
    <i class="fas fa-spinner fa-spin"></i>
  </div>
  <p>Loading repository details...</p>
</div>

<!-- Error State -->
<div *ngIf="error && !loading" class="error-state">
  <div class="error-icon">
    <i class="fas fa-exclamation-triangle"></i>
  </div>
  <h3>Error Loading Repository</h3>
  <p>{{ error }}</p>
  <button class="btn-retry" (click)="goBack()">Go Back</button>
</div>
